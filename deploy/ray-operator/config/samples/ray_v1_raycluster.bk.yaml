apiVersion: ray.io/v1
kind: RayCluster
metadata:
  labels:
    controller-tools.k8s.io: "1.0"
  name: raycluster-sample
spec:
  clusterName: raycluster-sample
  images:
    defaultImage: "reg.docker.alibaba-inc.com/volvo_ci_arcx/ray_package:a59ce20ec8b9876a67df84ca45dc456481bc2d3a"
    clusterApiServerImage: "reg.docker.alibaba-inc.com/zeromem/clusterapiserver:20191008"
  imagePullPolicy: "Always"

  # optional `extensions`, and all sub-options are optional.
  extensions:
    - size: 2
      groupName: group1
      type: worker
      idList: ["raycluster-sample-group1-worker-0","raycluster-sample-group1-worker-1"]

      # custom labels. NOTE: do not define custom labels start with `raycluster.`, they may be used in controller.
      labels:
        sigma.ali/app-name: raycluster
        raycluster.group.name: group1

      # use affinity to select nodes.
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: sigma.ali/is-over-quota
                    operator: In
                    values: ["true"]
                  - key: custom.k8s.alipay.com/csi-ulogfs-support
                    operator: In
                    values: ["true"]

      tolerations:
        - key: "sigma.ali/is-over-quota"
          operator: "Equal"
          value: "true"
          effect: "NoSchedule"

      # resource requirements
      resources:
        limits:
          cpu: 1000m
          memory: 1Gi
          ephemeral-storage: 4Gi
        requests:
          cpu: 1000m
          memory: 1Gi
          ephemeral-storage: 4Gi

      # environment variables to set in the container
      containerEnv:
        - name: ALIPAY_APP_NAME
          value: raycluster-sample
        - name: IDCNAME
          value: gtjsqa
        - name: APPNAME
          value: raycluster
        - name: POD_READY_FILEPATH
          value: /home/admin/logs/ray/ray-core.log
        - name: PVC_MOUNT_PATH
          value: /tmp/

      # head service suffix
      headServiceSuffix: "ray-operator.svc.gtjsqa.alipay.net"

      volumes:
        - name: log-volume
          emptyDir: {}

      volumeMounts:
        - mountPath: /home/admin/ray/logs
          name: log-volume

    - size: 1
      groupName: group2
      type: worker
      idList: ["raycluster-sample-group2-worker-0"]

      # custom labels. NOTE: do not define custom labels start with `raycluster.`, they may be used in controller.
      labels:
        sigma.ali/app-name: raycluster
        sigma.ali/instance-group: sigma-alipay-test
        sigma.ali/deploy-unit: sigma-alipay-test
        sigma.ali/site: gtjsqa
        meta.k8s.alipay.com/zone: GZ00C
        raycluster.group.name: group2

      # use affinity to select nodes.
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: sigma.ali/is-over-quota
                    operator: In
                    values: ["true"]
                  - key: custom.k8s.alipay.com/csi-ulogfs-support
                    operator: In
                    values: ["true"]

      tolerations:
        - key: "sigma.ali/is-over-quota"
          operator: "Equal"
          value: "true"
          effect: "NoSchedule"

      # resource requirements
      resources:
        limits:
          cpu: 1000m
          memory: 1Gi
          ephemeral-storage: 4Gi
        requests:
          cpu: 1000m
          memory: 1Gi
          ephemeral-storage: 4Gi

      # environment variables to set in the container
      containerEnv:
        - name: ALIPAY_APP_NAME
          value: raycluster-sample
        - name: IDCNAME
          value: gtjsqa
        - name: APPNAME
          value: raycluster
        - name: POD_READY_FILEPATH
          value: /home/admin/logs/ray/ray-core.log
        - name: PVC_MOUNT_PATH
          value: /tmp/

      # head service suffix
      headServiceSuffix: "ray-operator.svc.gtjsqa.alipay.net"

      volumes:
        - name: log-volume
          emptyDir: {}

      volumeMounts:
        - mountPath: /home/admin/ray/logs
          name: log-volume

    - size: 1
      groupName: group2
      type: clusterApiServer
      idList: ["raycluster-sample-group2-clusterapiserver-0"]

      # custom labels. NOTE: do not define custom labels start with `raycluster.`, they may be used in controller.
      labels:
        sigma.ali/app-name: raycluster
        sigma.ali/instance-group: sigma-alipay-test
        sigma.ali/deploy-unit: sigma-alipay-test
        sigma.ali/site: gtjsqa
        meta.k8s.alipay.com/zone: GZ00C
        raycluster.group.name: group2

        # use affinity to select nodes.
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: sigma.ali/is-over-quota
                    operator: In
                    values: ["true"]
      tolerations:
        - key: "sigma.ali/is-over-quota"
          operator: "Equal"
          value: "true"
          effect: "NoSchedule"

      # resource requirements
      resources:
        limits:
          cpu: 1000m
          memory: 1Gi
          ephemeral-storage: 4Gi
        requests:
          cpu: 1000m
          memory: 1Gi
          ephemeral-storage: 4Gi

      # environment variables to set in the container
      containerEnv:
        - name: ALIPAY_APP_NAME
          value: raycluster-sample
        - name: IDCNAME
          value: gtjsqa
        - name: APPNAME
          value: raycluster
        - name: POD_READY_FILEPATH
          value: /logs/server.log
        - name: MY_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: MY_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: PVC_MOUNT_PATH
          value: /tmp/


      # head service suffix
      headServiceSuffix: "ray-operator.svc.gtjsqa.alipay.net"

      volumes:
        - name: log-volume
          emptyDir: {}

      volumeMounts:
        - mountPath: /home/admin/ray/logs
          name: log-volume

    - size: 1
      groupName: headgroup1
      type: head
      idList: ["raycluster-sample-group2-head-0"]

      # custom labels. NOTE: do not define custom labels start with `raycluster.`, they may be used in controller.
      labels:
        sigma.ali/app-name: raycluster
        sigma.ali/instance-group: sigma-alipay-test
        sigma.ali/deploy-unit: sigma-alipay-test
        sigma.ali/site: gtjsqa
        meta.k8s.alipay.com/zone: GZ00C
        raycluster.group.name: headgroup1

      # use affinity to select nodes.
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: sigma.ali/is-over-quota
                    operator: In
                    values: ["true"]
                  - key: custom.k8s.alipay.com/csi-ulogfs-support
                    operator: In
                    values: ["true"]
      tolerations:
        - key: "sigma.ali/is-over-quota"
          operator: "Equal"
          value: "true"
          effect: "NoSchedule"

      # resource requirements
      resources:
        limits:
          cpu: 1000m
          memory: 1Gi
          ephemeral-storage: 4Gi
        requests:
          cpu: 1000m
          memory: 1Gi
          ephemeral-storage: 4Gi

      # environment variables to set in the container
      containerEnv:
        - name: ALIPAY_APP_NAMEkub
          value: raycluster-sample
        - name: IDCNAME
          value: gtjsqa
        - name: APPNAME
          value: raycluster
        - name: POD_READY_FILEPATH
          value: /home/admin/logs/ray/ray-core.log
        - name: MY_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: MY_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: PVC_MOUNT_PATH
          value: /tmp/

      # head service suffix
      headServiceSuffix: "ray-operator.svc.gtjsqa.alipay.net"

      volumes:
        - name: log-volume
          emptyDir: {}

      volumeMounts:
        - mountPath: /home/admin/ray/logs
          name: log-volume
